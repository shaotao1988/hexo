---
layout: post
title: 数据库查询性能优化
description: 
updated: 2018-09-09
tags: [数据库]
---

数据库查询性能优化

<!-- more -->

## 优化数据访问

### 应用程序是否在检索大量超过需要的数据

- 查询不需要的记录
  比如让MySQL查询全部数据集，客户端接受全部数据集后抛弃其中大部分数据
- 多表关联时返回全部列
- 总是取出全部列
  有时为了方便缓存，取出了全部的数据列。需要综合评估缓存和数据库查询的性能问题。
- 重复查询相同的数据
  必要时应当考虑使用缓存

### MySQL是否在扫描额外的记录

衡量查询开销的3个指标
- 响应时间: 服务时间+排队时间(I/O、锁等)
- 扫描的行数
  explain语句的type列反映了访问类型，从全表扫描到索引扫描、范围扫描、唯一索引查询、常数引用等。
- 返回的行数

MySQL使用如下三种方式应用where条件，从好到坏依次为：
- 在索引中使用where条件来过滤不匹配的记录，在存储引擎层完成
- 使用覆盖索引返回记录（Extra列中出现了using index)，直接从索引中过滤不需要的记录并返回结果。这在MySQL服务器层完成，但无须再回表查询
- 从数据表中返回记录，然后过滤不满足条件的记录（Extra列中出现using where）。有MySQL服务器层完成，需要先从数据表读出数据再过滤
 
## 重构查询的方式

### 一个复杂查询还是多个简单查询

如果一个查询能胜任，尽量不要写成多个查询

### 切分查询

对于大查询分而治之，切分成多个小查询，防止一次锁住很多数据，耗尽系统资源，影响其它比较重要的查询

删除也是一样，例如需要定期清理老数据，如果数据列很大，可以一次只清理10000条

### 分解关联查询

对关联查询中的每一个表进行一次单表查询，然后将结果在应用程序中进行关联
- 让数据库缓存的效率更高。如果关联中的某个表发生变化，数据库就无法使用查询缓存了。而拆分后，没有变化的表就可以重复利用缓存的结果
- 相比较关联查询，单个查询可以减少锁的竞争
- 在应用层做关联，更容易对数据库做拆分，数据库扩展性更好

